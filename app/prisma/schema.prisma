generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/cfo_budgeting_app/app/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  firstName     String?
  lastName      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  transactions  Transaction[]
  categories    Category[]
  debts         Debt[]
  goals         Goal[]
  budgets       Budget[]
  notifications Notification[]
  csvUploads    CsvUpload[]
  financialMetrics FinancialMetrics?
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Core Financial Models
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  amount      Float
  description String
  merchant    String?
  category    String
  categoryId  String?
  type        TransactionType // INCOME, EXPENSE, TRANSFER
  account     String?
  csvUploadId String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryRelation Category? @relation(fields: [categoryId], references: [id])
  csvUpload CsvUpload? @relation(fields: [csvUploadId], references: [id])

  @@index([userId, date])
  @@index([userId, category])
}

model Category {
  id          String   @id @default(cuid())
  userId      String
  name        String
  color       String   @default("#3B82F6")
  icon        String   @default("folder")
  budget      Float?
  type        CategoryType // EXPENSE, INCOME
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name])
}

model Debt {
  id            String   @id @default(cuid())
  userId        String
  name          String
  balance       Float
  interestRate  Float
  minimumPayment Float
  dueDate       Int      // Day of month (1-31)
  type          DebtType // CREDIT_CARD, STUDENT_LOAN, MORTGAGE, PERSONAL_LOAN, OTHER
  priority      Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments DebtPayment[]

  @@index([userId, isActive])
}

model DebtPayment {
  id        String   @id @default(cuid())
  debtId    String
  amount    Float
  date      DateTime
  principal Float?
  interest  Float?
  createdAt DateTime @default(now())

  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@index([debtId, date])
}

model Goal {
  id           String   @id @default(cuid())
  userId       String
  name         String
  description  String?
  targetAmount Float
  currentAmount Float   @default(0)
  targetDate   DateTime?
  type         GoalType // EMERGENCY_FUND, DEBT_PAYOFF, SAVINGS, INVESTMENT, OTHER
  priority     Int      @default(0)
  isCompleted  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isCompleted])
}

model Budget {
  id        String     @id @default(cuid())
  userId    String
  name      String
  month     Int        // 1-12
  year      Int
  amount    Float
  spent     Float      @default(0)
  category  String
  type      BudgetType // MONTHLY, WEEKLY, YEARLY
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, month, year])
  @@index([userId, month, year])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType // BILL_REMINDER, BUDGET_ALERT, GOAL_PROGRESS, DEBT_REMINDER, OTHER
  title     String
  message   String
  isRead    Boolean          @default(false)
  isActive  Boolean          @default(true)
  dueDate   DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, dueDate])
}

model CsvUpload {
  id            String   @id @default(cuid())
  userId        String
  fileName      String
  originalName  String
  cloudStoragePath String
  recordCount   Int      @default(0)
  processedCount Int     @default(0)
  status        UploadStatus // PENDING, PROCESSING, COMPLETED, FAILED
  mappingConfig Json?    // Column mapping configuration
  errorLog      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, status])
}

model FinancialMetrics {
  id                String   @id @default(cuid())
  userId            String   @unique
  monthlyIncome     Float?
  monthlyExpenses   Float?
  monthlyBurnRate   Float?
  totalDebt         Float?   @default(0)
  totalAssets       Float?   @default(0)
  netWorth          Float?
  emergencyFundGoal Float?
  debtToIncomeRatio Float?
  lastCalculated    DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Enums
enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum DebtType {
  CREDIT_CARD
  STUDENT_LOAN
  MORTGAGE
  PERSONAL_LOAN
  AUTO_LOAN
  OTHER
}

enum GoalType {
  EMERGENCY_FUND
  DEBT_PAYOFF
  SAVINGS
  INVESTMENT
  VACATION
  OTHER
}

enum BudgetType {
  MONTHLY
  WEEKLY
  YEARLY
}

enum NotificationType {
  BILL_REMINDER
  BUDGET_ALERT
  GOAL_PROGRESS
  DEBT_REMINDER
  CSV_PROCESSED
  OTHER
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
