generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/cfo_budgeting_app/app/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  firstName     String?
  lastName      String?
  companyName   String?
  jobTitle      String?
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String?
  zipCode       String?
  businessType  BusinessType @default(SMALL_BUSINESS)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts           Account[]
  sessions           Session[]
  transactions       Transaction[]
  categories         Category[]
  debts              Debt[]
  goals              Goal[]
  budgets            Budget[]
  notifications      Notification[]
  csvUploads         CsvUpload[]
  financialMetrics   FinancialMetrics?
  
  // Business entities
  customers          Customer[]
  vendors            Vendor[]
  contractors        Contractor[]
  products           Product[]
  services           Service[]
  invoices           Invoice[]
  estimates          Estimate[]
  projects           Project[]
  employees          Employee[]
  tasks              Task[]
  documents          Document[]
  bills              Bill[]
  expenseClaims      ExpenseClaim[]
  receipts           Receipt[]
  automations        Automation[]
  chartOfAccounts    ChartOfAccount[]
  journalEntries     JournalEntry[]
  reconciliations    Reconciliation[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Core Financial Models
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  amount      Float
  description String
  merchant    String?
  category    String
  categoryId  String?
  vendorId    String?
  type        TransactionType // INCOME, EXPENSE, TRANSFER
  account     String?
  csvUploadId String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryRelation Category? @relation(fields: [categoryId], references: [id])
  csvUpload CsvUpload? @relation(fields: [csvUploadId], references: [id])
  vendor    Vendor?    @relation(fields: [vendorId], references: [id])

  @@index([userId, date])
  @@index([userId, category])
}

model Category {
  id          String   @id @default(cuid())
  userId      String
  name        String
  color       String   @default("#3B82F6")
  icon        String   @default("folder")
  budget      Float?
  type        CategoryType // EXPENSE, INCOME
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name])
}

model Debt {
  id            String   @id @default(cuid())
  userId        String
  name          String
  balance       Float
  interestRate  Float
  minimumPayment Float
  dueDate       Int      // Day of month (1-31)
  type          DebtType // CREDIT_CARD, STUDENT_LOAN, MORTGAGE, PERSONAL_LOAN, OTHER
  priority      Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments DebtPayment[]

  @@index([userId, isActive])
}

model DebtPayment {
  id        String   @id @default(cuid())
  debtId    String
  amount    Float
  date      DateTime
  principal Float?
  interest  Float?
  createdAt DateTime @default(now())

  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@index([debtId, date])
}

model Goal {
  id           String   @id @default(cuid())
  userId       String
  name         String
  description  String?
  targetAmount Float
  currentAmount Float   @default(0)
  targetDate   DateTime?
  type         GoalType // EMERGENCY_FUND, DEBT_PAYOFF, SAVINGS, INVESTMENT, OTHER
  priority     Int      @default(0)
  isCompleted  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isCompleted])
}

model Budget {
  id        String     @id @default(cuid())
  userId    String
  name      String
  month     Int        // 1-12
  year      Int
  amount    Float
  spent     Float      @default(0)
  category  String
  type      BudgetType // MONTHLY, WEEKLY, YEARLY
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, month, year])
  @@index([userId, month, year])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType // BILL_REMINDER, BUDGET_ALERT, GOAL_PROGRESS, DEBT_REMINDER, OTHER
  title     String
  message   String
  isRead    Boolean          @default(false)
  isActive  Boolean          @default(true)
  dueDate   DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, dueDate])
}

model CsvUpload {
  id            String   @id @default(cuid())
  userId        String
  fileName      String
  originalName  String
  cloudStoragePath String
  recordCount   Int      @default(0)
  processedCount Int     @default(0)
  status        UploadStatus // PENDING, PROCESSING, COMPLETED, FAILED
  mappingConfig Json?    // Column mapping configuration
  errorLog      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, status])
}

model FinancialMetrics {
  id                String   @id @default(cuid())
  userId            String   @unique
  monthlyIncome     Float?
  monthlyExpenses   Float?
  monthlyBurnRate   Float?
  totalDebt         Float?   @default(0)
  totalAssets       Float?   @default(0)
  netWorth          Float?
  emergencyFundGoal Float?
  debtToIncomeRatio Float?
  lastCalculated    DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Business Models
model Customer {
  id          String   @id @default(cuid())
  userId      String
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  taxId       String?
  website     String?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices    Invoice[]
  estimates   Estimate[]
  projects    Project[]

  @@index([userId, isActive])
}

model Vendor {
  id          String   @id @default(cuid())
  userId      String
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  taxId       String?
  website     String?
  notes       String?
  paymentTerms String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  bills       Bill[]
  expenses    Transaction[]

  @@index([userId, isActive])
}

model Contractor {
  id          String   @id @default(cuid())
  userId      String
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  taxId       String?
  rate        Float?
  rateType    RateType @default(HOURLY) // HOURLY, DAILY, PROJECT
  specialty   String?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects    Project[]
  tasks       Task[]

  @@index([userId, isActive])
}

model Product {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  sku         String?
  price       Float
  cost        Float?
  category    String?
  unit        String?
  taxable     Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]
  estimateItems EstimateItem[]

  @@index([userId, isActive])
  @@index([userId, category])
}

model Service {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  rate        Float
  unit        String   @default("hour") // hour, day, project
  category    String?
  taxable     Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]
  estimateItems EstimateItem[]

  @@index([userId, isActive])
  @@index([userId, category])
}

model Invoice {
  id           String        @id @default(cuid())
  userId       String
  customerId   String
  invoiceNumber String       @unique
  title        String?
  description  String?
  issueDate    DateTime
  dueDate      DateTime
  subtotal     Float
  taxRate      Float         @default(0)
  taxAmount    Float         @default(0)
  total        Float
  amountPaid   Float         @default(0)
  status       InvoiceStatus @default(DRAFT)
  terms        String?
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items        InvoiceItem[]
  payments     Payment[]

  @@index([userId, status])
  @@index([userId, dueDate])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  productId   String?
  serviceId   String?
  description String
  quantity    Float
  rate        Float
  amount      Float
  createdAt   DateTime @default(now())

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])
}

model Estimate {
  id           String         @id @default(cuid())
  userId       String
  customerId   String
  estimateNumber String       @unique
  title        String?
  description  String?
  issueDate    DateTime
  expiryDate   DateTime?
  subtotal     Float
  taxRate      Float          @default(0)
  taxAmount    Float          @default(0)
  total        Float
  status       EstimateStatus @default(DRAFT)
  terms        String?
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer     Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items        EstimateItem[]

  @@index([userId, status])
  @@index([userId, expiryDate])
}

model EstimateItem {
  id          String  @id @default(cuid())
  estimateId  String
  productId   String?
  serviceId   String?
  description String
  quantity    Float
  rate        Float
  amount      Float
  createdAt   DateTime @default(now())

  estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id])
  service  Service? @relation(fields: [serviceId], references: [id])
}

model Project {
  id          String        @id @default(cuid())
  userId      String
  customerId  String?
  contractorId String?
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  status      ProjectStatus @default(PLANNING)
  priority    Priority      @default(MEDIUM)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer    Customer?   @relation(fields: [customerId], references: [id])
  contractor  Contractor? @relation(fields: [contractorId], references: [id])
  tasks       Task[]
  documents   Document[]

  @@index([userId, status])
}

model Employee {
  id          String   @id @default(cuid())
  userId      String
  firstName   String
  lastName    String
  email       String
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  ssn         String?
  hireDate    DateTime
  salary      Float?
  hourlyRate  Float?
  jobTitle    String?
  department  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paychecks   Paycheck[]
  timesheets  Timesheet[]

  @@index([userId, isActive])
}

model Paycheck {
  id          String   @id @default(cuid())
  employeeId  String
  payPeriodStart DateTime
  payPeriodEnd DateTime
  grossPay    Float
  netPay      Float
  taxes       Float
  deductions  Float
  createdAt   DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model Timesheet {
  id         String   @id @default(cuid())
  employeeId String
  date       DateTime
  hoursWorked Float
  description String?
  approved   Boolean  @default(false)
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model Task {
  id           String     @id @default(cuid())
  userId       String
  projectId    String?
  contractorId String?
  title        String
  description  String?
  priority     Priority   @default(MEDIUM)
  status       TaskStatus @default(TODO)
  dueDate      DateTime?
  completedAt  DateTime?
  estimatedHours Float?
  actualHours    Float?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  project    Project?    @relation(fields: [projectId], references: [id])
  contractor Contractor? @relation(fields: [contractorId], references: [id])

  @@index([userId, status])
  @@index([userId, dueDate])
}

model Document {
  id              String       @id @default(cuid())
  userId          String
  projectId       String?
  name            String
  description     String?
  fileName        String
  cloudStoragePath String
  fileSize        Int?
  mimeType        String?
  category        DocumentCategory @default(OTHER)
  isPublic        Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id])

  @@index([userId, category])
}

model Bill {
  id          String     @id @default(cuid())
  userId      String
  vendorId    String?
  billNumber  String?
  description String
  amount      Float
  dueDate     DateTime
  paidDate    DateTime?
  status      BillStatus @default(PENDING)
  category    String?
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor Vendor? @relation(fields: [vendorId], references: [id])

  @@index([userId, status])
  @@index([userId, dueDate])
}

model ExpenseClaim {
  id          String            @id @default(cuid())
  userId      String
  title       String
  description String?
  amount      Float
  date        DateTime
  category    String?
  status      ExpenseClaimStatus @default(SUBMITTED)
  receiptPath String?
  notes       String?
  approvedAt  DateTime?
  paidAt      DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, date])
}

model Receipt {
  id              String   @id @default(cuid())
  userId          String
  vendor          String?
  amount          Float
  date            DateTime
  category        String?
  description     String?
  cloudStoragePath String?
  ocrText         String?
  processed       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([userId, processed])
}

model Automation {
  id          String          @id @default(cuid())
  userId      String
  name        String
  description String?
  trigger     AutomationTrigger
  action      AutomationAction
  conditions  Json?
  isActive    Boolean         @default(true)
  lastRun     DateTime?
  runCount    Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
}

model ChartOfAccount {
  id          String      @id @default(cuid())
  userId      String
  code        String
  name        String
  type        AccountType
  parentId    String?
  description String?
  balance     Float       @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent         ChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children       ChartOfAccount[] @relation("AccountHierarchy")
  journalEntries JournalEntryLine[]

  @@unique([userId, code])
  @@index([userId, type])
}

model JournalEntry {
  id          String   @id @default(cuid())
  userId      String
  entryNumber String
  date        DateTime
  description String
  reference   String?
  totalDebit  Float
  totalCredit Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  lines JournalEntryLine[]

  @@unique([userId, entryNumber])
  @@index([userId, date])
}

model JournalEntryLine {
  id              String  @id @default(cuid())
  journalEntryId  String
  accountId       String
  description     String?
  debitAmount     Float   @default(0)
  creditAmount    Float   @default(0)

  journalEntry JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      ChartOfAccount @relation(fields: [accountId], references: [id])
}

model Reconciliation {
  id              String              @id @default(cuid())
  userId          String
  accountId       String?
  month           Int
  year            Int
  openingBalance  Float
  closingBalance  Float
  bankBalance     Float?
  status          ReconciliationStatus @default(PENDING)
  difference      Float               @default(0)
  notes           String?
  reconciledAt    DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId, status])
}

model Payment {
  id        String      @id @default(cuid())
  invoiceId String
  amount    Float
  date      DateTime
  method    PaymentMethod @default(BANK_TRANSFER)
  reference String?
  notes     String?
  createdAt DateTime    @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// Enums
enum BusinessType {
  SMALL_BUSINESS
  CORPORATION
  LLC
  PARTNERSHIP
  SOLE_PROPRIETORSHIP
  NONPROFIT
}

enum RateType {
  HOURLY
  DAILY
  PROJECT
  MONTHLY
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum EstimateStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  DECLINED
  EXPIRED
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DocumentCategory {
  CONTRACT
  INVOICE
  RECEIPT
  REPORT
  IMAGE
  SPREADSHEET
  PRESENTATION
  OTHER
}

enum BillStatus {
  PENDING
  SCHEDULED
  PAID
  OVERDUE
  CANCELLED
}

enum ExpenseClaimStatus {
  SUBMITTED
  APPROVED
  REJECTED
  PAID
}

enum AutomationTrigger {
  INVOICE_CREATED
  PAYMENT_RECEIVED
  BILL_DUE
  PROJECT_COMPLETED
  TASK_OVERDUE
  MONTHLY_REPORT
}

enum AutomationAction {
  SEND_EMAIL
  CREATE_TASK
  GENERATE_REPORT
  UPDATE_STATUS
  CREATE_INVOICE
  SEND_REMINDER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum ReconciliationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  NEEDS_REVIEW
}

enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CREDIT_CARD
  PAYPAL
  STRIPE
  OTHER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum DebtType {
  CREDIT_CARD
  STUDENT_LOAN
  MORTGAGE
  PERSONAL_LOAN
  AUTO_LOAN
  OTHER
}

enum GoalType {
  EMERGENCY_FUND
  DEBT_PAYOFF
  SAVINGS
  INVESTMENT
  VACATION
  OTHER
}

enum BudgetType {
  MONTHLY
  WEEKLY
  YEARLY
}

enum NotificationType {
  BILL_REMINDER
  BUDGET_ALERT
  GOAL_PROGRESS
  DEBT_REMINDER
  CSV_PROCESSED
  OTHER
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
